#!/bin/zsh

#  Preinstall script for ReportMate
#  Removes existing LaunchDaemons and prepares for new installation
#
#  Based on macadmins/outset pattern

# Configuration
LD_ROOT="/Library/LaunchDaemons"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log_message "Starting ReportMate preinstall..."

# Legacy LaunchDaemons (from previous versions)
LEGACY_DAEMONS=(
    "${LD_ROOT}/com.github.reportmate.plist"
)

# Current LaunchDaemons
CURRENT_DAEMONS=(
    "${LD_ROOT}/com.github.reportmate.boot.plist"
    "${LD_ROOT}/com.github.reportmate.hourly.plist"
    "${LD_ROOT}/com.github.reportmate.fourhourly.plist"
    "${LD_ROOT}/com.github.reportmate.daily.plist"
)

# Unload and remove legacy daemons
log_message "Checking for legacy LaunchDaemons..."
for daemon in ${LEGACY_DAEMONS}; do
    if [ -e "${daemon}" ]; then
        log_message "  Removing legacy daemon: ${daemon}"
        /bin/launchctl bootout system "${daemon}" 2>/dev/null
        rm -f "${daemon}"
    fi
done

# Unload current daemons (will be reinstalled by postinstall)
log_message "Unloading current LaunchDaemons..."
for daemon in ${CURRENT_DAEMONS}; do
    if [ -e "${daemon}" ]; then
        log_message "  Unloading: ${daemon}"
        /bin/launchctl bootout system "${daemon}" 2>/dev/null
        rm -f "${daemon}"
    fi
done

# Kill any running ReportMate processes
log_message "Stopping any running ReportMate processes..."
pkill -f "managedreportsrunner" 2>/dev/null || true

log_message "ReportMate preinstall complete."

exit 0
