#!/bin/bash

# ReportMate Postinstall Script
# Configures the client with production settings
# This script is intended to be run by the installer (root privileges required)

# =================================================================
# CONFIGURATION
# =================================================================

# Production API URL
# Injected from .env file via munkipkg (Key Vault secret: reportmate-custom-domain-name)
API_URL="https://${REPORTMATE_CUSTOM_DOMAIN_NAME}"

# API Key (Passphrase)
# Injected from .env file via munkipkg (Key Vault secret: reportmate-client-passphrase)
API_KEY="${REPORTMATE_CLIENT_PASSPHRASE}"

# Collection Interval in seconds (default: 3600 = 1 hour)
COLLECTION_INTERVAL=3600

# Log Level (debug, info, warning, error)
LOG_LEVEL="info"

# Enabled Modules
ENABLED_MODULES=("hardware" "system" "network" "security" "applications" "management" "inventory")

# Preference Domain (DO NOT CHANGE - must match Swift ConfigurationManager)
DOMAIN="com.github.reportmate"
PREFS_PATH="/Library/Preferences/${DOMAIN}"
PLIST_PATH="${PREFS_PATH}.plist"

# =================================================================
# LOGGING
# =================================================================

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# =================================================================
# MAIN
# =================================================================

log_message "Starting ReportMate configuration..."

# Ensure we are running as root
if [ "$EUID" -ne 0 ]; then
    log_message "ERROR: This script must be run as root"
    exit 1
fi

# Set API URL
if [ -n "$API_URL" ]; then
    log_message "Setting ApiUrl to $API_URL"
    defaults write "$PREFS_PATH" ApiUrl -string "$API_URL"
else
    log_message "WARNING: API_URL is not set"
fi

# Set API Key
if [ -n "$API_KEY" ]; then
    log_message "Setting ApiKey"
    defaults write "$PREFS_PATH" ApiKey -string "$API_KEY"
fi

# Set Collection Interval
log_message "Setting CollectionInterval to $COLLECTION_INTERVAL"
defaults write "$PREFS_PATH" CollectionInterval -int $COLLECTION_INTERVAL

# Set Log Level
log_message "Setting LogLevel to $LOG_LEVEL"
defaults write "$PREFS_PATH" LogLevel -string "$LOG_LEVEL"

# Set Enabled Modules
log_message "Setting EnabledModules"
defaults write "$PREFS_PATH" EnabledModules -array "${ENABLED_MODULES[@]}"

# Fix permissions
log_message "Setting permissions on preference file..."
if [ -f "$PLIST_PATH" ]; then
    chmod 644 "$PLIST_PATH"
else
    log_message "WARNING: Plist file not found at $PLIST_PATH"
fi

# Reload preferences to ensure cached values are updated
killall cfprefsd 2>/dev/null

log_message "Configuration complete."

exit 0
